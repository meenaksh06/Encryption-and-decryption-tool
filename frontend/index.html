<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Secure File Encryption & Decryption</title>

  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    /* basic reset so paddings/margins don't surprise us */
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family:
        Inter,
        -apple-system,
        BlinkMacSystemFont,
        "Segoe UI",
        sans-serif;
      background: #f8fafc;
      color: #0f172a;
    }

    /* two-card layout that wraps nicely on smaller screens */
    .container {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
      gap: 32px;
      flex-wrap: wrap;
    }

    .card {
      background: #ffffff;
      width: 100%;
      max-width: 420px;
      border-radius: 14px;
      padding: 32px;
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
    }

    .title {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 6px;
    }

    .subtitle {
      font-size: 14px;
      color: #64748b;
      margin-bottom: 24px;
    }

    .file-input {
      width: 100%;
      padding: 12px;
      border: 1px dashed #cbd5e1;
      border-radius: 10px;
      background: #f8fafc;
    }

    .text-input {
      width: 100%;
      padding: 12px;
      border: 1px solid #cbd5e1;
      border-radius: 10px;
      background: #f8fafc;
      font-size: 12px;
      font-family: monospace;
      margin-top: 12px;
      outline: none;
      transition: border-color 0.2s;
    }

    .text-input:focus {
      border-color: #0f172a;
    }

    .text-input::placeholder {
      color: #94a3b8;
    }

    .input-label {
      font-size: 12px;
      font-weight: 600;
      color: #475569;
      margin-top: 16px;
      margin-bottom: 4px;
    }

    .button {
      margin-top: 20px;
      width: 100%;
      padding: 12px;
      background: #0f172a;
      color: #ffffff;
      border: none;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
    }

    .button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .button-decrypt {
      background: #1e40af;
    }

    /* result boxes for showing keys, hashes, messages */
    .result {
      margin-top: 24px;
      padding: 16px;
      background: #f8fafc;
      border-radius: 10px;
      border: 1px solid #e2e8f0;
    }

    .result-success {
      border-color: #86efac;
      background: #f0fdf4;
    }

    .result-error {
      border-color: #fca5a5;
      background: #fef2f2;
    }

    .label {
      font-size: 12px;
      font-weight: 600;
      color: #475569;
      margin-top: 12px;
    }

    .value {
      font-size: 12px;
      word-break: break-all;
      margin-top: 4px;
    }

    .clear-btn {
      margin-top: 12px;
      background: none;
      border: none;
      color: #64748b;
      font-size: 12px;
      cursor: pointer;
    }

    .footer-note {
      margin-top: 16px;
      font-size: 11px;
      color: #94a3b8;
      text-align: center;
    }

    /* green badge for security status messages */
    .secure-badge {
      margin-top: 16px;
      padding: 10px 14px;
      background: #f0fdf4;
      border: 1px solid #86efac;
      border-radius: 8px;
      font-size: 12px;
      color: #166534;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    /* red button for secure file deletion */
    .secure-delete-btn {
      margin-top: 10px;
      width: 100%;
      padding: 10px;
      background: #dc2626;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
    }

    .secure-delete-btn:hover {
      background: #b91c1c;
    }

    .secure-delete-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .delete-result {
      margin-top: 10px;
      padding: 10px 14px;
      background: #fef3c7;
      border: 1px solid #fbbf24;
      border-radius: 8px;
      font-size: 12px;
      color: #92400e;
    }

    .delete-result-success {
      background: #f0fdf4;
      border-color: #86efac;
      color: #166534;
    }

    /* integrity check result badges */
    .integrity-match {
      margin-top: 12px;
      padding: 10px 14px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .integrity-pass {
      background: #f0fdf4;
      border: 1px solid #86efac;
      color: #166534;
    }

    .integrity-fail {
      background: #fef2f2;
      border: 1px solid #fca5a5;
      color: #dc2626;
    }
  </style>
</head>

<body>
  <div id="root"></div>

  <script type="text/babel">
    function App() {
      // ‚îÄ‚îÄ encryption side state ‚îÄ‚îÄ
      const [encFile, setEncFile] = React.useState(null);
      const [key, setKey] = React.useState(
        localStorage.getItem("enc_key") || "",
      );
      const [iv, setIv] = React.useState(
        localStorage.getItem("enc_iv") || "",
      );
      const [encLoading, setEncLoading] = React.useState(false);
      const [encryptedFileName, setEncryptedFileName] = React.useState("");
      const [secureNote, setSecureNote] = React.useState("");
      const [deleteLoading, setDeleteLoading] = React.useState(false);
      const [deleteResult, setDeleteResult] = React.useState("");

      // SHA-256 hash of the original file ‚Äî we get this from the server
      // after encryption so we can verify integrity later
      const [originalHash, setOriginalHash] = React.useState(
        localStorage.getItem("enc_sha256") || "",
      );

      // ‚îÄ‚îÄ decryption side state ‚îÄ‚îÄ
      const [decFile, setDecFile] = React.useState(null);
      const [decKey, setDecKey] = React.useState(
        localStorage.getItem("enc_key") || "",
      );
      const [decIv, setDecIv] = React.useState(
        localStorage.getItem("enc_iv") || "",
      );
      const [decLoading, setDecLoading] = React.useState(false);
      const [decMessage, setDecMessage] = React.useState("");
      const [decError, setDecError] = React.useState("");

      // the expected hash ‚Äî user can paste it here before decrypting
      // so we can compare it against what the server computes
      const [expectedHash, setExpectedHash] = React.useState(
        localStorage.getItem("enc_sha256") || "",
      );
      // result of the integrity comparison after decryption
      const [integrityResult, setIntegrityResult] = React.useState(null);

      // keep decryption inputs in sync when new keys come from encryption
      React.useEffect(() => {
        setDecKey(key);
        setDecIv(iv);
      }, [key, iv]);

      // also sync the expected hash when we get a new one from encryption
      React.useEffect(() => {
        setExpectedHash(originalHash);
      }, [originalHash]);

      // ‚îÄ‚îÄ encrypt handler ‚îÄ‚îÄ
      const encryptFile = async () => {
        if (!encFile) return;

        setEncLoading(true);

        try {
          const arrayBuffer = await encFile.arrayBuffer();

          const res = await fetch("http://localhost:8080/encrypt", {
            method: "POST",
            headers: {
              "Content-Type": "application/octet-stream",
              "x-filename": encFile.name,
            },
            body: arrayBuffer,
          });

          const data = await res.json();

          // persist everything to localStorage so it survives page refreshes
          localStorage.setItem("enc_key", data.privateKey);
          localStorage.setItem("enc_iv", data.iv);
          localStorage.setItem("enc_sha256", data.sha256);

          setKey(data.privateKey);
          setIv(data.iv);
          setEncryptedFileName(data.encryptedFileName || "");
          setSecureNote(data.secureNote || "");
          setOriginalHash(data.sha256 || "");
          setDeleteResult("");
        } catch (err) {
          console.error("Encryption failed:", err);
        } finally {
          setEncLoading(false);
        }
      };

      // ‚îÄ‚îÄ decrypt handler ‚îÄ‚îÄ
      // after decryption, we grab the SHA-256 hash from the response header
      // and compare it to the expected hash to check for tampering
      const decryptFile = async () => {
        if (!decFile || !decKey || !decIv) return;

        setDecLoading(true);
        setDecMessage("");
        setDecError("");
        setIntegrityResult(null);

        try {
          const arrayBuffer = await decFile.arrayBuffer();

          const res = await fetch("http://localhost:8080/decrypt", {
            method: "POST",
            headers: {
              "Content-Type": "application/octet-stream",
              "x-private-key": decKey.trim(),
              "x-iv": decIv.trim(),
              "x-filename": decFile.name.replace(/\.\d+-[a-f0-9]+\.enc$/, ""),
            },
            body: arrayBuffer,
          });

          if (!res.ok) {
            const errData = await res.json();
            setDecError(errData.error || "Decryption failed");
            return;
          }

          const blob = await res.blob();

          // pull the SHA-256 hash that the server computed on the decrypted output
          const decryptedHash = res.headers.get("X-Decrypted-SHA256");

          // figure out a reasonable filename for the download
          let filename = decFile.name.replace(/\.\d+-[a-f0-9]+\.enc$/, "");
          if (!filename || filename === decFile.name) {
            filename = "decrypted_file";
          }

          // trigger the browser download
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = filename;
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);

          setDecMessage("File decrypted and downloaded successfully!");

          // integrity verification ‚Äî compare the hash from decryption
          // against what the user provided as the expected hash
          if (expectedHash && decryptedHash) {
            const match =
              expectedHash.trim().toLowerCase() ===
              decryptedHash.trim().toLowerCase();
            setIntegrityResult({
              match,
              expected: expectedHash.trim().toLowerCase(),
              actual: decryptedHash.trim().toLowerCase(),
            });
          } else if (decryptedHash) {
            // no expected hash was provided, so we just show what we got
            setIntegrityResult({
              match: null,
              actual: decryptedHash,
            });
          }
        } catch (err) {
          console.error("Decryption failed:", err);
          setDecError("Decryption request failed. Check console for details.");
        } finally {
          setDecLoading(false);
        }
      };

      // ‚îÄ‚îÄ clear everything ‚îÄ‚îÄ
      const clearKeys = () => {
        localStorage.removeItem("enc_key");
        localStorage.removeItem("enc_iv");
        localStorage.removeItem("enc_sha256");
        setKey("");
        setIv("");
        setEncryptedFileName("");
        setSecureNote("");
        setDeleteResult("");
        setOriginalHash("");
      };

      // ‚îÄ‚îÄ secure delete handler ‚îÄ‚îÄ
      const secureDeleteFile = async () => {
        if (!encryptedFileName) return;
        setDeleteLoading(true);
        setDeleteResult("");
        try {
          const res = await fetch("http://localhost:8080/secure-delete", {
            method: "POST",
            headers: {
              "x-filename": encryptedFileName,
            },
          });
          const data = await res.json();
          if (res.ok) {
            setDeleteResult(
              `üóëÔ∏è File securely deleted: ${data.passes} passes, ${data.bytesOverwritten.toLocaleString()} bytes overwritten.`,
            );
            setEncryptedFileName("");
          } else {
            setDeleteResult(`‚ùå ${data.error}`);
          }
        } catch (err) {
          setDeleteResult("‚ùå Secure delete request failed.");
        } finally {
          setDeleteLoading(false);
        }
      };

      return (
        <div className="container">
          {/* ‚îÄ‚îÄ Encryption Card ‚îÄ‚îÄ */}
          <div className="card">
            <div className="title">Secure File Encryption</div>
            <div className="subtitle">
              Upload a file to encrypt it securely using AES encryption.
            </div>

            <input
              type="file"
              className="file-input"
              onChange={(e) => setEncFile(e.target.files[0])}
            />

            <button
              type="button"
              className="button"
              disabled={!encFile || encLoading}
              onClick={encryptFile}
            >
              {encLoading ? "Encrypting..." : "Encrypt File"}
            </button>

            {key && (
              <div className="result">
                <div className="label">Private Key</div>
                <div className="value">{key}</div>

                <div className="label">Initialization Vector (IV)</div>
                <div className="value">{iv}</div>

                {/* show the SHA-256 fingerprint so users can copy it for later */}
                {originalHash && (
                  <>
                    <div className="label">SHA-256 Integrity Hash</div>
                    <div className="value" style={{ color: "#7c3aed" }}>
                      {originalHash}
                    </div>
                  </>
                )}

                <button className="clear-btn" onClick={clearKeys}>
                  Clear keys
                </button>
              </div>
            )}

            {secureNote && (
              <div className="secure-badge">
                üõ°Ô∏è {secureNote}
              </div>
            )}

            {encryptedFileName && (
              <button
                type="button"
                className="secure-delete-btn"
                disabled={deleteLoading}
                onClick={secureDeleteFile}
              >
                {deleteLoading
                  ? "Securely Deleting..."
                  : "üóëÔ∏è Secure Delete from Server"}
              </button>
            )}

            {deleteResult && (
              <div
                className={`delete-result ${deleteResult.startsWith("üóëÔ∏è")
                    ? "delete-result-success"
                    : ""
                  }`}
              >
                {deleteResult}
              </div>
            )}

            <div className="footer-note">
              Keys and hash are stored locally in your browser.
            </div>
          </div>

          {/* ‚îÄ‚îÄ Decryption Card ‚îÄ‚îÄ */}
          <div className="card">
            <div className="title">Secure File Decryption</div>
            <div className="subtitle">
              Upload an encrypted file and provide the key & IV to decrypt.
            </div>

            <input
              type="file"
              className="file-input"
              accept=".enc"
              onChange={(e) => setDecFile(e.target.files[0])}
            />

            <div className="input-label">Private Key</div>
            <input
              type="text"
              className="text-input"
              placeholder="Paste your 64-character hex key"
              value={decKey}
              onChange={(e) => setDecKey(e.target.value)}
            />

            <div className="input-label">Initialization Vector (IV)</div>
            <input
              type="text"
              className="text-input"
              placeholder="Paste your 32-character hex IV"
              value={decIv}
              onChange={(e) => setDecIv(e.target.value)}
            />

            {/* optional: paste the original hash here to verify integrity */}
            <div className="input-label">Expected SHA-256 Hash (optional)</div>
            <input
              type="text"
              className="text-input"
              placeholder="Paste the 64-character SHA-256 hash to verify integrity"
              value={expectedHash}
              onChange={(e) => setExpectedHash(e.target.value)}
            />

            <button
              type="button"
              className="button button-decrypt"
              disabled={!decFile || !decKey || !decIv || decLoading}
              onClick={decryptFile}
            >
              {decLoading ? "Decrypting..." : "Decrypt File"}
            </button>

            {decMessage && (
              <div className="result result-success">
                <div className="value">{decMessage}</div>
              </div>
            )}

            {/* integrity check result ‚Äî shows whether the hashes match */}
            {integrityResult && integrityResult.match === true && (
              <div className="integrity-match integrity-pass">
                ‚úÖ Integrity verified ‚Äî SHA-256 hashes match. File is untampered.
              </div>
            )}

            {integrityResult && integrityResult.match === false && (
              <div className="integrity-match integrity-fail">
                ‚ö†Ô∏è Integrity check FAILED ‚Äî hashes do not match! File may have been tampered with.
                <div className="value" style={{ marginTop: "8px" }}>
                  Expected: {integrityResult.expected}<br />
                  Got: {integrityResult.actual}
                </div>
              </div>
            )}

            {integrityResult && integrityResult.match === null && (
              <div className="integrity-match" style={{ background: "#f8fafc", border: "1px solid #e2e8f0", color: "#475569" }}>
                üîç Decrypted file SHA-256: {integrityResult.actual}
              </div>
            )}

            {decError && (
              <div className="result result-error">
                <div className="value" style={{ color: "#dc2626" }}>
                  {decError}
                </div>
              </div>
            )}

            <div className="footer-note">
              The decrypted file will download automatically.
            </div>
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>

</html>